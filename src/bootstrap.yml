variant: fcos
version: 1.0.0
ignition:
  config:
    merge:
      - source: https://raw.githubusercontent.com/gtherond/ignition/master/build/runtime.ign

# Allowing a remote privileged user login for DEBUG and RECOVERY purpose, this key should be stored securely and only available to
# a restricted amount of authorized and properly identified people.
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICuOd04cEYQXzbnR+bXsKWhHqrcUkTMOodP62JcZPMN2"

# Create an update wariness and reboot strategy, as we're not in a clustered environment we don't use fleet_lock reboot strategy.
storage:
  files:
    - path: /etc/hostname
      mode: 0640
      contents:
        inline: |
          ns1.bitswalk.net

    - path: /etc/zincati/config.d/51-rollout-wariness.toml
      mode: 0640
      contents:
        inline: |
          [identity]
          rollout_wariness = 0.5

    - path: /etc/zincati/config.d/55-updates-strategy.toml
      mode: 0640
      contents:
        inline: |
          [updates]
          strategy = "immediate"
    
    - path: /etc/ssh/sshd_config
      mode: 0640
      append:
        - inline: |
            Port 2222
            LoginGraceTime 2m
            StrictModes yes
            MaxAuthTries 4
            MaxSessions 5
            PubkeyAuthentication yes
            PermitEmptyPassword no
            AllowAgentForwarding yes
            AllowTcpForwarding no
            GatewayPorts no
            X11Forwarding no
            TCPKeepAlive yes
            Compression delayed

systemd:
  units:
    - name: sshd-selinux.service
      enabled: true
      contents: |
        [Unit]
        Description=Change selinux ssh domain config
        ConditionFirstBoot=yes
        Wants=network-online.target
        After=network-online.target
        After=multi-user.target
        Before=boot-complete.target

        [Service]
        Type=oneshot
        ExecStart=semanage port -a -t ssh_port_t -p tcp 2222

        [Install]
        RequiredBy=boot-complete.target
        WantedBy=multi-user.target